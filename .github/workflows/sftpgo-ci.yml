name: CI for Docker Compose and Terraform

on:
  push:
    branches:
      - main
    paths:
      - Projets/Template/SFTPGo/**
      - .github/workflows/sftpgo-ci.yml

  pull_request:
    branches:
      - main
    paths:
      - Projets/Template/SFTPGo/**
      - .github/workflows/sftpgo-ci.yml

jobs:
  docker-compose:
    name: Test Docker Compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install docker-compose -y

      - name: Build and run Docker Compose
        run: |
          docker compose up -d --build
          
      - name: Verify services are running
        run: docker compose ps

      - name: Tear down Docker Compose
        if: always()
        run: docker compose down

  terraform:
    name: Test Terraform
    runs-on: ubuntu-latest
    needs: docker-compose

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Terraform Init, Validate, Plan, and Apply
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace hashicorp/terraform:1.9.2 \
          sh -c "
          terraform init &&
          terraform validate &&
          terraform plan &&
          terraform apply -auto-approve -input=false -lock=false -no-color
          "
